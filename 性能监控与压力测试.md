---
title: 性能监控与压力测试
tags:
  - jvm
categories:
  - notes
  - 后端
abbrlink: 8b856bf3
date: 2020-10-17 11:10:13
---

##### 性能监控与压力测试

- 性能监控
- 压力测试

<!--more-->

##### 性能监控

###### 1、jvm内存模型

![jvm内存模型](https://gitee.com/lao-biao/Pictures/raw/master/%E5%90%8E%E7%AB%AF/jvm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png)

- 程序计数器（Program Counter Register）：记录的是正在执行的虚拟机字节码指令的地址，此内存区域是唯一一个在Java虚拟规范中没有规定任何OutOfMemoryError的区域。
- 虚拟机栈（VMstack）：
  - 描述的是Java方法执行的内存模型，每个方法在执行的时候都会创建一个栈帧，用于存储局部变量表，操作数栈，动态链接，方法接口等信息。
  - 局部变量表存储了编译期可知的各种数据类型、对象引用；
  - 线程请求的栈深度不够会报StackOverflowError异常；
  - 栈动态扩展的容量不够会报OutOfMemoryError异常；
  - 虚拟机栈式线程隔离的，即每个线程都有自己独立的虚拟机栈。
- 本地方法栈（Native Stack）：本地方法栈类似于虚拟机栈，只不过本地方法栈使用的是本地方法。
- 堆（Heap）：几乎所有的对象实例都在堆上分配内存。
  ![堆模型](https://gitee.com/lao-biao/Pictures/raw/master/%E5%90%8E%E7%AB%AF/%E5%A0%86%E6%A8%A1%E5%9E%8B.png)

###### 2、堆

所有的对象实例以及数组都要在堆上分配。堆是垃圾收集器管理的主要区域，也被称为“GC堆”，也是优化考虑最多的地方。

堆可以细分为

- 新生代：Eden空间、From Survivor空间、To Survivor空间
- 老年代
- 永久代/元空间：Java8以前，永久代受jvm管理；在Java8以后，元空间直接使用物理内存。默认情况下，元空间的大小仅受本地内存限制。

垃圾回收

![垃圾回收](https://gitee.com/lao-biao/Pictures/raw/master/%E5%90%8E%E7%AB%AF/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6.png)

从Java8开始，Hotspot已经完全将永久代（Permanent Generation）移除，取而代之的是一个新的区域：元空间（Metaspace）。

###### 3、jconsole与jvisualvm

jdk的两个小工具jconsole、jvisualvm（升级版的jconsole，jdk1.6），通过命令行启动， 可监控本地和远程应用。远程应用需要配置。

***jvisualvm功能***：监控内存泄漏，跟踪垃圾回收，执行时内存、cpu分析，线程分析…

![jvisualvm功能](https://gitee.com/lao-biao/Pictures/raw/master/%E5%90%8E%E7%AB%AF/jvisualvm%E5%8A%9F%E8%83%BD.png)

- 运行：正在运行的
- 休眠：sleep
- 等待：wait
- 驻留：线程池里面的空闲线程
- 监视：阻塞的显示

***安装插件方便查看gc***：jvisualvm 工具->插件

###### 4、监控指标

**中间件指标**

**数据库指标**

- SQL耗时越小越好，一般情况下微秒级别；
- 命中率越高越好，一般情况下不能低于95%；
- 锁等待次数越低越好，等待时间越短越好。

> `-Xmx100m`

| 压测内容                               | 压测线程数 | 吞吐量/s          | 90%响应时间 | 99%响应时间 |
| -------------------------------------- | ---------- | ----------------- | ----------- | ----------- |
| nginx（cpu）                           | 50         | 1613              | 47          | 86          |
| gateway(cpu)                           | 50         | 4215              | 16          | 34          |
| 简单服务(无中间件)                     | 50         | 6482              | 18          | 64          |
| 首页一级菜单渲染                       | 50         | 216(db,thymeleaf) | 345         | 696         |
| 首页渲染(缓存)                         | 50         | 有提升            |             |             |
| 首页渲染(缓存，优化db(加索引)，关日志) | 50         | 有较大提升        |             |             |
| 三级分类数据获取                       | 50         | 2(db)             | -           | -           |
| 三级分类数据获取(优化业务)             | 50         | 93                |             |             |
| 三级分类数据获取(使用redis作为缓存)    | 50         | 840               | 84          | 115         |
| 首页全量数据获取                       | 50         | 7(静态资源)       | -           | -           |
| nginx+gateway                          | 50         |                   |             |             |
| gateway+简单服务                       | 50         | 1304              | 79          | 149         |
| 全链路                                 | 50         | 113               | 1016        | 7031        |

- <font color=red>中间件越多，性能损失越大，大多都损失在网络交互；</font>
- 业务
  - db（MySQL优化：服务器、索引）
  - 模板渲染速度（缓存）
  - 静态资源：nginx动静分离

###### 5、jvm分析与调优

**几个常用工具**

**命令示例**

**调优项**

##### 压力测试

压力测试考察当前软硬件环境下系统所能承受的最大负荷，并帮助找出系统瓶颈所在。压测都是为了系统在线上的处理能力和稳定性维持在一个标准范围内。

使用压力测试，有希望找到很多种其他测试方法更难发现的错误。有两种错误类型是**内存泄漏**，**并发与同步**。

有效的压力测试将应用以下这些关键条件：**重复**，**并发**，**量级**，**随机变化**。

###### 1、性能指标

- *RT*（Response Time）响应时间： 指用户从客户端发起一个请求开始，到客户端接收到服务器返回的响应结束，整个过程所耗费的时间。
- *HPS*（Hits Per Second）：每秒点击数。
- *TPS*（Transaction per Second）：系统每秒处理交易数。（完整的业务流程，并不是单指数据库的事务）
- *QPS*（Query per Second）：系统每秒查询次数。
  对于互联网业务中，如果某些业务有且仅有一个请求连接，HPS=TPS=QPS，一般情况下用TPS来衡量整个业务流程，用QPS来衡量接口查询次数，用HPS表示对服务器单继请求。
- 无论TPS、QPS、HPS，此指标是衡量系统处理能力非常重要的指标，越大越好，根据经验，一般情况下：
  - 金融行业：1,000TPS~50,000TPS，不包括互联网化的活动
  - 保险行业：100TPS~100,000TPS，不包括互联网化的活动
  - 制造业：10TPS~5,000TPS
  - 互联网电子商务：10,000TPS~1,000,000TPS
  - 互联网中型网站：1,000TPS~50,000TPS
  - 互联网小型网站：500TPS~100,000TPS
- 最大响应时间（Max Response Time）：指用户发出请求或者指令到系统做出反应（响应）的最大时间。
- 最少响应时间（Minimum Response Time）：指用户发出请求或者指令到系统做反应（响应）的最少时间。
- 90%响应时间（90% Response Time）：指所有用户的响应时间进行排序，第90%的响应时间。
- 从外部看，性能测试主要关注以下三个指标：
  - *吞吐量*：每秒系统能够处理的请求数、任务数。
  - *响应时间*：服务处理一个请求或一个任务的耗时。
  - *错误率*：一批请求中结果出错的请求所占比例。

###### 2、JMeter

> https://jmeter.apache.org/

流程：

1. 添加线程组
2. 添加HTTP请求
3. 添加监听器
4. 启动压测，查看

影响性能考虑点：数据库、应用程序、中间件（tomcat、nginx）、网络和操作系统等。
应用类型：*CPU密集型*（计算、过滤、排序等）、*IO密集型*（网络、磁盘、数据库、redis等）。

<font color=red>Address Already in use 错误</font>
Windows本身提供的端口访问机制的问题。
Windows提供给 TCP/IP 链接的端口为1024-5000，并且要四分钟来循环回收它们，就导致在短时间内跑大量的请求时端口占满了。

1. 打开注册表（regedit）

2. 在 `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Paramters`下
   （1）右击parameters，添加一个新的DWORD，名字为MaxUserPort。
   （2）然后双击MaxUserPort，输入数值数据为65534，基数选择十进制。

   TCPTimedWaitDelay：30 

3. 修改配置完毕之后需要重启机器才会生效。
